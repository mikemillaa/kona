<!DOCTYPE HTML>
<html lang="en" class="ferra" dir="ltr">

<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>P2P - The Kona Book</title>


    <!-- Custom HTML head -->
    
    <meta name="description" content="Developer documentation for the Kona project.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff">

    <link rel="icon" href="../../favicon.svg">
    <link rel="shortcut icon" href="../../favicon.png">
    <link rel="stylesheet" href="../../css/variables.css">
    <link rel="stylesheet" href="../../css/general.css">
    <link rel="stylesheet" href="../../css/chrome.css">
    <link rel="stylesheet" href="../../css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
    <link rel="stylesheet" href="../../fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="../../highlight.css">
    <link rel="stylesheet" href="../../tomorrow-night.css">
    <link rel="stylesheet" href="../../ayu-highlight.css">

    <!-- Custom theme stylesheets -->
    <link rel="stylesheet" href="../../custom.css">

</head>

<body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ferra" : "ferra";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch (e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ferra')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch (e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../../protocol/intro.html"><strong aria-hidden="true">2.</strong> Protocol Libraries</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../protocol/derive/intro.html"><strong aria-hidden="true">2.1.</strong> Derivation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../protocol/derive/providers.html"><strong aria-hidden="true">2.1.1.</strong> Custom Providers</a></li><li class="chapter-item expanded "><a href="../../protocol/derive/stages.html"><strong aria-hidden="true">2.1.2.</strong> Stage Swapping</a></li><li class="chapter-item expanded "><a href="../../protocol/derive/signaling.html"><strong aria-hidden="true">2.1.3.</strong> Signaling</a></li></ol></li><li class="chapter-item expanded "><a href="../../protocol/genesis/intro.html"><strong aria-hidden="true">2.2.</strong> Genesis</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../protocol/genesis/rollup-config.html"><strong aria-hidden="true">2.2.1.</strong> Rollup Config</a></li><li class="chapter-item expanded "><a href="../../protocol/genesis/system-config.html"><strong aria-hidden="true">2.2.2.</strong> System Config</a></li></ol></li><li class="chapter-item expanded "><a href="../../protocol/registry.html"><strong aria-hidden="true">2.3.</strong> Registry</a></li><li class="chapter-item expanded "><a href="../../protocol/interop.html"><strong aria-hidden="true">2.4.</strong> Interop</a></li><li class="chapter-item expanded "><a href="../../protocol/hardforks.html"><strong aria-hidden="true">2.5.</strong> Hardforks</a></li><li class="chapter-item expanded "><a href="../../protocol/protocol/intro.html"><strong aria-hidden="true">2.6.</strong> Protocol</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../protocol/protocol/block-info.html"><strong aria-hidden="true">2.6.1.</strong> BlockInfo</a></li><li class="chapter-item expanded "><a href="../../protocol/protocol/l2-block-info.html"><strong aria-hidden="true">2.6.2.</strong> L2BlockInfo</a></li><li class="chapter-item expanded "><a href="../../protocol/protocol/frames.html"><strong aria-hidden="true">2.6.3.</strong> Frames</a></li><li class="chapter-item expanded "><a href="../../protocol/protocol/channels.html"><strong aria-hidden="true">2.6.4.</strong> Channels</a></li><li class="chapter-item expanded "><a href="../../protocol/protocol/batches.html"><strong aria-hidden="true">2.6.5.</strong> Batches</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../node/intro.html"><strong aria-hidden="true">3.</strong> Rollup Node</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/run-a-node.html"><strong aria-hidden="true">3.1.</strong> Run a Node</a></li><li class="chapter-item expanded "><a href="../../node/docker.html"><strong aria-hidden="true">3.2.</strong> Docker Support</a></li><li class="chapter-item expanded "><a href="../../node/monitoring.html"><strong aria-hidden="true">3.3.</strong> Monitoring</a></li><li class="chapter-item expanded "><a href="../../node/cli.html"><strong aria-hidden="true">3.4.</strong> CLI Reference</a></li><li class="chapter-item expanded "><a href="../../node/subcommands.html"><strong aria-hidden="true">3.5.</strong> Subcommands</a></li><li class="chapter-item expanded "><a href="../../node/design/intro.html"><strong aria-hidden="true">3.6.</strong> Design</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/design/derivation.html"><strong aria-hidden="true">3.6.1.</strong> Derivation</a></li><li class="chapter-item expanded "><a href="../../node/design/engine.html"><strong aria-hidden="true">3.6.2.</strong> Engine</a></li><li class="chapter-item expanded "><a href="../../node/design/p2p.html" class="active"><strong aria-hidden="true">3.6.3.</strong> P2P</a></li><li class="chapter-item expanded "><a href="../../node/design/sequencer.html"><strong aria-hidden="true">3.6.4.</strong> Sequencer</a></li><li class="chapter-item expanded "><a href="../../node/design/runtime.html"><strong aria-hidden="true">3.6.5.</strong> Runtime</a></li><li class="chapter-item expanded "><a href="../../node/design/supervisor.html"><strong aria-hidden="true">3.6.6.</strong> Supervisor</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../proof/intro.html"><strong aria-hidden="true">4.</strong> Proof SDK</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../proof/fpvm-backend.html"><strong aria-hidden="true">4.1.</strong> FPVM Backend</a></li><li class="chapter-item expanded "><a href="../../proof/custom-backend.html"><strong aria-hidden="true">4.2.</strong> Custom Backend</a></li><li class="chapter-item expanded "><a href="../../proof/exec-ext.html"><strong aria-hidden="true">4.3.</strong> kona-executor Extensions</a></li></ol></li><li class="chapter-item expanded "><a href="../../fpp-dev/intro.html"><strong aria-hidden="true">5.</strong> Fault Proof Program Development</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../fpp-dev/env.html"><strong aria-hidden="true">5.1.</strong> Environment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../fpp-dev/targets.html"><strong aria-hidden="true">5.1.1.</strong> Supported Targets</a></li></ol></li><li class="chapter-item expanded "><a href="../../fpp-dev/prologue.html"><strong aria-hidden="true">5.2.</strong> Prologue</a></li><li class="chapter-item expanded "><a href="../../fpp-dev/execution.html"><strong aria-hidden="true">5.3.</strong> Execution</a></li><li class="chapter-item expanded "><a href="../../fpp-dev/epilogue.html"><strong aria-hidden="true">5.4.</strong> Epilogue</a></li></ol></li><li class="chapter-item expanded "><a href="../../examples/intro.html"><strong aria-hidden="true">6.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../examples/load-a-rollup-config.html"><strong aria-hidden="true">6.1.</strong> Load a Rollup Config</a></li><li class="chapter-item expanded "><a href="../../examples/frames-to-batch.html"><strong aria-hidden="true">6.2.</strong> Transform Frames to a Batch</a></li><li class="chapter-item expanded "><a href="../../examples/batch-to-frames.html"><strong aria-hidden="true">6.3.</strong> Transform a Batch into Frames</a></li><li class="chapter-item expanded "><a href="../../examples/new-l1-block-info-tx-hardfork.html"><strong aria-hidden="true">6.4.</strong> Create a new L1BlockInfoTx Hardfork Variant</a></li><li class="chapter-item expanded "><a href="../../examples/executor-test-fixtures.html"><strong aria-hidden="true">6.5.</strong> Create a new kona-executor test fixture</a></li></ol></li><li class="chapter-item expanded "><a href="../../rfc/intro.html"><strong aria-hidden="true">7.</strong> RFC</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../rfc/umbrellas.html"><strong aria-hidden="true">7.1.</strong> Umbrellas</a></li></ol></li><li class="chapter-item expanded "><a href="../../archives/intro.html"><strong aria-hidden="true">8.</strong> Archives</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../archives/monorepo.html"><strong aria-hidden="true">8.1.</strong> Monorepo</a></li></ol></li><li class="chapter-item expanded "><a href="../../glossary.html"><strong aria-hidden="true">9.</strong> Glossary</a></li><li class="chapter-item expanded "><a href="../../CONTRIBUTING.html"><strong aria-hidden="true">10.</strong> Contributing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function (e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor"
                            title="Toggle Table of Contents" aria-label="Toggle Table of Contents"
                            aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                            aria-label="Change theme" aria-haspopup="true" aria-expanded="false"
                            aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ferra">Ferra</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                            aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                            aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Kona Book</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/op-rs/kona" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/op-rs/kona/edit/main/book/src/node/design/p2p.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..."
                            aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <style>
.mdbook-alerts {
  padding: 8px 16px;
  margin-bottom: 16px;
  border-left: 0.25em solid var(--mdbook-alerts-color);
}

.mdbook-alerts > *:first-child {
  margin-top: 0;
}

.mdbook-alerts > *:last-child {
  margin-bottom: 0;
}

.mdbook-alerts-title {
  display: flex;
  font-weight: 600;
  align-items: center;
  line-height: 1;
  color: var(--mdbook-alerts-color);
  text-transform: capitalize;
}

.mdbook-alerts-icon {
  display: inline-block;
  width: 1em;
  height: 1em;
  margin-right: 0.2em;
  background-color: currentColor;
  -webkit-mask: no-repeat center / 100%;
  mask: no-repeat center / 100%;
  -webkit-mask-image: var(--mdbook-alerts-icon);
  mask-image: var(--mdbook-alerts-icon);
}

.mdbook-alerts-note {
  --mdbook-alerts-color: rgb(9, 105, 218);
  /* https://icon-sets.iconify.design/material-symbols/info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11q-.425 0-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8q0 .425.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137q-1.35-1.35-2.137-3.175T2 12q0-2.075.788-3.9t2.137-3.175q1.35-1.35 3.175-2.137T12 2q2.075 0 3.9.788t3.175 2.137q1.35 1.35 2.138 3.175T22 12q0 2.075-.788 3.9t-2.137 3.175q-1.35 1.35-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12q0-3.35-2.325-5.675T12 4Q8.65 4 6.325 6.325T4 12q0 3.35 2.325 5.675T12 20m0-8"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-tip {
  --mdbook-alerts-color: rgb(26, 127, 55);
  /* https://icon-sets.iconify.design/material-symbols/lightbulb-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 22q-.825 0-1.412-.587T10 20h4q0 .825-.587 1.413T12 22m-3-3q-.425 0-.712-.288T8 18q0-.425.288-.712T9 17h6q.425 0 .713.288T16 18q0 .425-.288.713T15 19zm-.75-3q-1.725-1.025-2.738-2.75T4.5 9.5q0-3.125 2.188-5.312T12 2q3.125 0 5.313 2.188T19.5 9.5q0 2.025-1.012 3.75T15.75 16zm.6-2h6.3q1.125-.8 1.738-1.975T17.5 9.5q0-2.3-1.6-3.9T12 4Q9.7 4 8.1 5.6T6.5 9.5q0 1.35.613 2.525T8.85 14M12 14"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-important {
  --mdbook-alerts-color: rgb(130, 80, 223);
  /* https://icon-sets.iconify.design/material-symbols/chat-info-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 7q.425 0 .713-.288T13 6q0-.425-.288-.712T12 5q-.425 0-.712.288T11 6q0 .425.288.713T12 7m0 8q.425 0 .713-.288T13 14v-4q0-.425-.288-.712T12 9q-.425 0-.712.288T11 10v4q0 .425.288.713T12 15m-6 3l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-warning {
  --mdbook-alerts-color: rgb(154, 103, 0);
  /* https://icon-sets.iconify.design/material-symbols/warning-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M2.725 21q-.275 0-.5-.137t-.35-.363q-.125-.225-.137-.488t.137-.512l9.25-16q.15-.25.388-.375T12 3q.25 0 .488.125t.387.375l9.25 16q.15.25.138.513t-.138.487q-.125.225-.35.363t-.5.137zm1.725-2h15.1L12 6zM12 18q.425 0 .713-.288T13 17q0-.425-.288-.712T12 16q-.425 0-.712.288T11 17q0 .425.288.713T12 18m0-3q.425 0 .713-.288T13 14v-3q0-.425-.288-.712T12 10q-.425 0-.712.288T11 11v3q0 .425.288.713T12 15m0-2.5"%2F%3E%3C%2Fsvg%3E');
}

.mdbook-alerts-caution {
  --mdbook-alerts-color: rgb(207, 34, 46);
  /* https://icon-sets.iconify.design/material-symbols/brightness-alert-outline-rounded/ */
  --mdbook-alerts-icon: url('data:image/svg+xml,%3Csvg xmlns="http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg" width="24" height="24" viewBox="0 0 24 24"%3E%3Cpath fill="currentColor" d="M12 17q.425 0 .713-.288T13 16q0-.425-.288-.712T12 15q-.425 0-.712.288T11 16q0 .425.288.713T12 17m0-4q.425 0 .713-.288T13 12V8q0-.425-.288-.712T12 7q-.425 0-.712.288T11 8v4q0 .425.288.713T12 13m-3.35 7H6q-.825 0-1.412-.587T4 18v-2.65L2.075 13.4q-.275-.3-.425-.662T1.5 12q0-.375.15-.737t.425-.663L4 8.65V6q0-.825.588-1.412T6 4h2.65l1.95-1.925q.3-.275.663-.425T12 1.5q.375 0 .738.15t.662.425L15.35 4H18q.825 0 1.413.588T20 6v2.65l1.925 1.95q.275.3.425.663t.15.737q0 .375-.15.738t-.425.662L20 15.35V18q0 .825-.587 1.413T18 20h-2.65l-1.95 1.925q-.3.275-.662.425T12 22.5q-.375 0-.737-.15t-.663-.425zm.85-2l2.5 2.5l2.5-2.5H18v-3.5l2.5-2.5L18 9.5V6h-3.5L12 3.5L9.5 6H6v3.5L3.5 12L6 14.5V18zm2.5-6"%2F%3E%3C%2Fsvg%3E');
}

</style>
<h1 id="p2p-networking"><a class="header" href="#p2p-networking">P2P Networking</a></h1>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Partly adapted from the <a href="https://specs.optimism.io/protocol/rollup-node-p2p.html">OP Stack P2P Specs</a>.</p>
<p>Please reference the specs for up-to-date OP Stack requirements.</p>
</div>
<p>The OP Stack uses P2P networking on the consensus layer to share
the sequencer's view of the L2 chain with other nodes on the
network. L2 blocks shared via P2P are considered "unsafe", and
will be reorganized to match the canonical chain, prioritizing L1.</p>
<p>This means that behavior on the P2P layer does not affect the
rollup security. As such, rules around banning and scoring peers
based on their P2P gossip is policy - it is up to the user to
ultimately choose a configuration best for them.</p>
<p>To understand how the P2P is hooked up to the <code>kona-node</code>, jump
to the <a href="#-p2p-actor">P2P Actor</a> section below. Otherwise, read
on to learn more about the details of the P2P stack.</p>
<h3 id="topography"><a class="header" href="#topography">Topography</a></h3>
<p>The P2P stack topography consists of the following.</p>
<ul>
<li>Discovery of peers via <a href="https://github.com/ethereum/devp2p/blob/master/discv5/discv5.md">discv5</a>.</li>
<li>Gossip and peer connection management through <a href="https://libp2p.io/">libp2p</a>.</li>
<li>Publishing and validation of gossip by the node.</li>
</ul>
<p>In the <code>kona-node</code>, these layers are split up into modular
components either as modules or distinct crates.</p>
<h4 id="discovery"><a class="header" href="#discovery">Discovery</a></h4>
<p>Kona's discovery layer is encapsulated in a "driver" called
the <a href="https://github.com/op-rs/kona/blob/main/crates/node/p2p/src/discv5/mod.rs"><code>Discv5Driver</code></a>. When started, the driver spawns a
new thread to handle <a href="https://docs.rs/discv5/latest/discv5/struct.Discv5.html"><code>discv5::Discv5</code></a> events
from its event stream as well as metrics requests from the
<code>kona-node</code>. A "handler" is returned by the consumed
<a href="https://github.com/op-rs/kona/blob/main/crates/node/p2p/src/discv5/mod.rs"><code>Discv5Driver</code></a> which allows other components of
the <code>kona-node</code> to communicate through channels to the
spawned <a href="https://docs.rs/discv5/latest/discv5/struct.Discv5.html"><code>discv5::Discv5</code></a> service.</p>
<p>When peers are discovered by kona's discovery service, their
"ENR"s need to be validated to ensure those peers are
participating in the right network gossip. Ethereum Node
Records (ENRs) and how they are validated is discussed in a
<a href="#-node-identification">later section</a>. After their ENRs are
validated, they are forwarded to the consumer (in kona's case
libp2p) which establishes and manages the connection to the
node.</p>
<p>There are also a few more notable functions of Kona's discovery
driver.</p>
<ul>
<li>Every X seconds it attempts to discover random ENRs. This is
configurable using <code>Discv5Builder::with_interval</code></li>
<li>Every Y seconds it evicts a random ENR from the discovery
table to keep peer discovery fresh. This is configurable
using <code>Discv5Builder::with_discovery_randomize</code>.</li>
<li>Every Z seconds it stores it's ENR table at a configurable
location so if the service is restarted, it doesn't need to
rediscover peers, it can just use the stored peers. The
interval is configurable using
<code>Discv5Builder::with_store_interval</code>.</li>
</ul>
<h4 id="gossip"><a class="header" href="#gossip">Gossip</a></h4>
<p>L2 blocks on the OP Stack not otherwise derived from L1 are
shared over TCP in the P2P network of nodes. Unsafe L2 blocks
shared this way originate from the sequencer.</p>
<p>In the <code>kona-node</code>, L2 block gossip is handled through the
<a href="https://docs.rs/libp2p/latest/libp2p/struct.Swarm.html">libp2p Swarm</a>. The <code>GossipDriver</code> is the component
in the <code>kona-node</code> that manages the libp2p swarm, including
any interfacing with the swarm like dialing peers, publishing
payloads (L2 blocks), handling events from the swarm, and more.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>The libp2p swarm must be polled via <Swarm as Stream>
in order to make progress.</p>
<p>Through kona's <code>GossipDriver</code>, this can be done by looping
over and consuming events from <code>GossipDriver::next</code>.</p>
</div>
<p>The <code>GossipDriver</code> provides the methods to handle events
from the <a href="https://docs.rs/libp2p/latest/libp2p/struct.Swarm.html">libp2p Swarm</a>. Events should be consumed
this way in order to use the connection gater as well as peer
store and fields on the <code>GossipDriver</code>.</p>
<p>The <a href="https://docs.rs/libp2p/latest/libp2p/struct.Swarm.html">libp2p Swarm</a> listens on a specified
<a href="https://docs.rs/libp2p/0.56.0/libp2p/struct.Multiaddr.html"><code>Multiaddr</code></a>.</p>
<h4 id="l2-block-publishing"><a class="header" href="#l2-block-publishing">L2 Block Publishing</a></h4>
<p>As mentioned in <a href="#-gossip">the previous section</a>, L2 blocks
are published as payloads through the <a href="https://docs.rs/libp2p/latest/libp2p/struct.Swarm.html">libp2p Swarm</a>,
which is done using the <code>GossipDriver</code>. The actual payload
type that is published is an <a href="https://docs.rs/op-alloy-rpc-types-engine/latest/op_alloy_rpc_types_engine/struct.OpNetworkPayloadEnvelope.html"><code>OpNetworkPayloadEnvelope</code></a>,
which is well documented in the <a href="https://specs.optimism.io/protocol/rollup-node-p2p.html">OP Stack P2P Specs</a>.</p>
<p>L2 blocks published through the <code>GossipDriver</code> are published on
a "topic". The topic is used by the gossipsub protocol to publish
the message on that given topic, allowing peers to choose which
topics they wish to subscribe to.</p>
<h4 id="l2-block-validation"><a class="header" href="#l2-block-validation">L2 Block Validation</a></h4>
<p>L2 blocks are validated in kona through a trait-abstracted
"block handler". Since messages in the libp2p mesh network are
snappy compressed, they need to be decompressed and then decoded
for the correct <a href="https://specs.optimism.io/protocol/rollup-node-p2p.html#gossip-topics">block topic</a> those messages are
published on.</p>
<p>Only once the <a href="https://docs.rs/op-alloy-rpc-types-engine/latest/op_alloy_rpc_types_engine/struct.OpNetworkPayloadEnvelope.html"><code>OpNetworkPayloadEnvelope</code></a> is successfully
decoded for the corresponding block topic, is the block validated.</p>
<div class="mdbook-alerts mdbook-alerts-note">
<p class="mdbook-alerts-title">
  <span class="mdbook-alerts-icon"></span>
  note
</p>
<p>Block validity in kona follows the <a href="https://specs.optimism.io/protocol/rollup-node-p2p.html#block-validation">OP Stack block validation specs</a>.</p>
</div>
<p>As of writing these docs, block validation follows a few rules.</p>
<ul>
<li>The timestamp is between 60 seconds in the past and at most 5 seconds in the future.</li>
<li>The block hash is valid. This is checked by transforming the paylaod into a block
and then hashing the block header to produce the payload hash.</li>
<li>The contents of the payload envelope are correct for its version. Since different
versions introduce new contents to the payload from hardforks, the
forwards-compatible payload envelope cannot have fields with content that don't exist
for previous versions.</li>
<li>The block signature is valid.</li>
</ul>
<h3 id="node-identification"><a class="header" href="#node-identification">Node Identification</a></h3>
<p>TODO</p>
<h3 id="p2p-actor"><a class="header" href="#p2p-actor">P2P Actor</a></h3>
<p>TODO</p>
<!-- Hyperlinks -->

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <a rel="prev" href="../../node/design/engine.html" class="mobile-nav-chapters previous"
                            title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                            <i class="fa fa-angle-left"></i>
                        </a>

                        <a rel="next prefetch" href="../../node/design/sequencer.html" class="mobile-nav-chapters next"
                            title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                            <i class="fa fa-angle-right"></i>
                        </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                <a rel="prev" href="../../node/design/engine.html" class="nav-chapters previous" title="Previous chapter"
                    aria-label="Previous chapter" aria-keyshortcuts="Left">
                    <i class="fa fa-angle-left"></i>
                </a>

                <a rel="next prefetch" href="../../node/design/sequencer.html" class="nav-chapters next" title="Next chapter"
                    aria-label="Next chapter" aria-keyshortcuts="Right">
                    <i class="fa fa-angle-right"></i>
                </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../mermaid.min.js"></script>
        <script src="../../mermaid-init.js"></script>


    </div>
</body>

</html>
